<%= render 'projects/projects_header' %>
<div style="height: 90vh;width: 100vw; overflow:scroll; ">
  <table class="table table-hover text-center">
    <thead>
      <tr style="color: #0067a3; border-bottom: 3px solid #0067a3;border-top: 3px solid #0067a3; height: 50px; vertical-align: middle;">
        <th scope="col" style="min-width: 200px;">Task Name</th>
        <th scope="col" >Duration</th>
        <th scope="col" style="width: 130px;">Start</th>
        <th scope="col" ></th>
        <th scope="col" style="width: 130px;">Finish</th>
        <th scope="col" >Assigned To</th>
        <th scope="col" style="min-width: 150px;">% Complete</th>
        <th scope="col" style="min-width: 100px;">Date Completed</th>
        <th scope="col" style="min-width: 200px;">Status</th>
        <th scope="col" >Output</th>
        <th scope="col" >Remarks</th>
        <th scope="col" style="min-width:100px;">Actions</th>
      </tr>
    </thead>
    <tbody>
      <% @rocks.each do |rock| %>
        <!-- All Rocks -->
        <tr class="all-rocks" style="background-color:#cccdd4; font-weight: bold; vertical-align: middle;">
          <td style="display: none;" id="rock-id"><%= rock.id %></td>
          <td class="task-name" style="text-align: left; min-width: 100px;">
            <%= image_tag ("plus.png"),role:"button", style:"margin-left:1rem",class:"plus-icon" %>
            <%= image_tag ("minus.png"),role:"button", style:"margin-left:1rem",class:"minus-icon" %>
            <%= rock.task_name %>
          </td>
          <!-- display none -->
          <td style="display: none;" id="isrock">rock</td>
          <td style="display: none;" id="percent-sum"><%= rock.milestones.pluck(:complete).reduce(:+) %></td>
          <td style="display: none;" id="m-count"><%= rock.milestones.count %></td>
          <!-- messages -->
          <td style="display: none;" class="m-current-user"><%= current_user.first_name %> <%= current_user.last_name%></td>
          <td style="display: none;" class="message-id"><%= rock.rockmessages.order(created_at: :asc).pluck(:id) %></td>
          <td style="display: none;" class="milestone-messages"><%= rock.rockmessages.order(created_at: :asc).pluck(:message) %></td>
          <td style="display: none;" class="message-firstname"><%= rock.rockmessages.order(created_at: :asc).pluck(:first_name) %></td>
          <td style="display: none;" class="message-lastname"><%= rock.rockmessages.order(created_at: :asc).pluck(:last_name) %></td>
          <td style="display: none;" class="message-time"><%= rock.rockmessages.order(created_at: :asc).pluck(:time) %></td>
          <!-- display none -->
          <td>
            <%= (rock.start.to_date..rock.finish.to_date).count do |date|
              date.workday?
            end %> days
          </td>
          <td>[ <%= rock.start.strftime("%b %d, %Y") %></td>
          <td>>></td>
          <td><%= rock.finish.strftime("%b %d, %Y") %> ]</td>
          <td class="assigned">
            <% if !rock.user.profilepics.blank? %>
              <%= image_tag rock.user.profilepics.last.pic, class:"assigned-pics", title:rock.user.email %>
            <% end %>
            <% @all_users.each do |user| %>
              <% if rock.assigned.include? user.email %>
                <% if user.id == rock.user.id %>
                <% elsif !user.profilepics.blank?%>
                  <%= image_tag user.profilepics.last.pic, class:"assigned-pics", title:user.email %>
                <% else %>
                  <%= image_tag ("profile-pic.png"), class:"assigned-pics", title:user.email %>
                <% end %>
              <% end %>
            <% end %>
          </td>
          <td class="rock-percent"><span></span> %</td>
          <td class="date-completed">
            <% if rock.date_completed.nil? %>
              - -
            <% else %>
              <%= rock.date_completed.strftime("%b %d, %Y") %>
            <% end %>
          </td>
          <td class="rock-status com-status py-2">
            <div class="d-flex align-items-center justify-content-center">
              <div id="stat" class="px-3 py-2" style="flex:4"></div>
              <% if rock.finish >= Date.today %>
                <div style="margin-left: 1rem; flex:1;text-align:start;" role="button" title="on track" class="track"><%= image_tag ("blue_circle.png")%></div>  
              <% else %>
                <div style="margin-left: 1rem; flex:1;text-align:start;" role="button" title="off track" class="track"><%= image_tag ("red_circle.png")%></div>  
              <% end %>
            </div>
          </td>
          <td><div style="min-height:min-content; max-height:100px; width:200px; white-space:pre-line; overflow:auto;"><%= rock.output %></div></td>
          <td><div style="min-height:min-content; max-height:100px; width:200px; white-space:pre-line; overflow:auto;"><%= rock.remarks %></div></td>
          <% if rock.rockmessages.empty? %>
            <td class="notif-con"><%= image_tag ("message.png"), class:"message-icon project-icon m-message"%></td>
          <% else %>
            <td class="notif-con"><%= image_tag ("message_1.png"), class:"message-icon project-icon m-message"%></td>
          <% end %>
        </tr>
        <!-- All Milestones -->
        <% @milestones.each do |milestone| %> 
          <% if rock.id == milestone.rock_id %>
            <tr class="all-milestones rock-<%= rock.id %>" style="vertical-align: middle;">
              <td style="display: none;" id="rock-id"><%= rock.id %></td>
              <td style="display: none;" id="milestone-id"><%= milestone.id %></td>
              <!-- messages -->
              <td style="display: none;" class="m-current-user"><%= current_user.first_name %> <%= current_user.last_name%></td>
              <td style="display: none;" class="message-id"><%= milestone.messages.order(created_at: :asc).pluck(:id) %></td>
              <td style="display: none;" class="milestone-messages"><%= milestone.messages.order(created_at: :asc).pluck(:message) %></td>
              <td style="display: none;" class="message-firstname"><%= milestone.messages.order(created_at: :asc).pluck(:first_name) %></td>
              <td style="display: none;" class="message-lastname"><%= milestone.messages.order(created_at: :asc).pluck(:last_name) %></td>
              <td style="display: none;" class="message-time"><%= milestone.messages.order(created_at: :asc).pluck(:time) %></td>
              <td class="task-name" style="text-align: left; min-width: 100px; padding-left:4rem"><%= milestone.task_name %></td>
              <td>
                <%= (milestone.start.to_date..milestone.finish.to_date).count do |date|
                  date.workday?
                end %> days
              </td>
              <td>[ <%= milestone.start.strftime("%b %d, %Y") %></td>
              <td>>></td>
              <td><%= milestone.finish.strftime("%b %d, %Y") %> ]</td>
              <td class="assigned">
                <% if !milestone.user.profilepics.blank? %>
                  <%= image_tag milestone.user.profilepics.last.pic, class:"assigned-pics", title:milestone.user.email %>
                <% end %>
                <% @all_users.each do |user| %>
                  <% if user.id == milestone.user.id %>
                  <% elsif milestone.assigned.include? user.email %>
                    <% if !user.profilepics.blank? %>
                      <%= image_tag user.profilepics.last.pic, class:"assigned-pics", title:user.email %>
                    <% else %>
                      <%= image_tag ("profile-pic.png"), class:"assigned-pics", title:user.email %>
                    <% end %>
                  <% end %>
                <% end %>
              </td>
              <td><span class="complete"><%= milestone.complete %></span> %</td>
              <td class="date-completed">
                <% if milestone.date_completed.nil? %>
                  - -
                <% else %>
                  <%= milestone.date_completed.strftime("%b %d, %Y") %>
                <% end %>
              </td>
              <td class="status com-status px-4">
                <div class="d-flex align-items-center justify-content-center">
                  <% case milestone.complete %>
                    <% when 0 %>
                      <div class="bg-light px-2 py-1" style="flex:4">Not Started</div>
                    <% when 100 %>
                      <div class="bg-success p-2 py-1" style="flex:4">Complete</div>
                    <% else %>
                      <div class="bg-warning p-2 py-1" style="flex:4">In Progress</div>
                  <% end %>
  
                  <% if milestone.finish >= Date.today %>
                    <div style="margin-left: 1rem; flex:1;text-align:start;" role="button" title="on track" class="track"><%= image_tag ("blue_circle.png")%></div>  
                  <% else %>
                    <div style="margin-left: 1rem; flex:1;text-align:start;" role="button" title="off track" class="track"><%= image_tag ("red_circle.png")%></div>  
                  <% end %>
                </div>
              </td>
              <td><div style="min-height:min-content; max-height:100px; width:200px; white-space:pre-line; overflow:auto;"><%= milestone.output %></div></td>
              <td><div style="min-height:min-content; max-height:100px; width:200px; white-space:pre-line; overflow:auto;"><%= milestone.remarks %></div></td>
              <% if milestone.messages.empty? %>
                <td class="notif-con" ><%= image_tag ("message.png"), class:"message-icon project-icon m-message", style:"margin-left: 30px;" %></td>
              <% else %>
                <td class="notif-con" ><%= image_tag ("message_1.png"), class:"message-icon project-icon m-message", style:"margin-left: 30px;" %></td>
              <% end %>
            </tr>
          <% end %>
        <% end %>
        <tr>
          <td></td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
        </tr>
      <% end %>
    </tbody>
    <%= render 'projects/messages' %>
  </table>
</div>

<script>

$(document).ready(function(){

    // hover messages
  // $(".message-icon").css("display","none")
  // $(".notif-con").hover(function(){
  //   $(this).children(".message-icon").toggle()
  // })

  // Complete and Status Column
  $(".rock-percent").each( function(index,value) {
    // Rock Percentage Value
    let percent_sum = $(value).siblings("#percent-sum").text()
    let m_count = $(value).siblings("#m-count").text()
    let total_rock_percent = m_count == "0" ? 0 : (parseInt(percent_sum) / (100 *  parseInt(m_count))) * 100
    $(value).children("span").text(total_rock_percent.toFixed(2))
    // Status Value and Complete status style
    let rock_percent = $(value).children("span").text()
    if (rock_percent == "0.00") {
      $(value).siblings(".rock-status").find("#stat").text("Not Started")
      $(value).siblings(".rock-status").find("#stat").css("background-color", "silver")
    }else if (rock_percent == "100.00") {
      $(value).siblings(".rock-status").find("#stat").text("Complete")
      $(value).siblings(".rock-status").find("#stat").css("background-color", "green")
    }else {
      $(value).siblings(".rock-status").find("#stat").text("In Progress")
      $(value).siblings(".rock-status").find("#stat").css("background-color", "yellow")
    }
  });
  
  $(".com-status").each( function(index,value) {
    if ($(value).text().replace(/\s/g, "") == "Complete"){
      $(value).parents("tr").children("td").not(".notif-con").css("text-decoration", "line-through")
      $(value).parents("tr").children("td").not(".notif-con").css("text-decoration-color", "red")
      $(value).parents("tr").children("td").not(".notif-con").css("font-style", "italic")
      $(value).find(".track").hide()
    }
  });

  // -----Milestone Section------

  // Show / Hide Milestones
  $(".minus-icon").css("display", "none")
  $(".all-milestones").css("display", "none")
  $(".new-milestone").css("display", "none")
  $(".blank-milestone").css("display", "none")
  $(".plus-icon").each( function(index,plus) {
    $(plus).click(function(){
      $(this).hide()
      $(this).next(".minus-icon").show()
      var id = $(plus).parents(".task-name").siblings("#rock-id").text()
      var rock_id = ".rock-" + id
      $(rock_id).show()
      $(rock_id + ".new-milestone").hide()
    });
  });
  $(".minus-icon").each( function(index,minus) {
    $(minus).click(function(){
      $(this).hide()
      $(this).prev(".plus-icon").show()
      var id = $(minus).parents(".task-name").siblings("#rock-id").text()
      var rock_id = ".rock-" + id
      $(rock_id).hide()
    });
  });

  // Message Section
  $(".message-bg").css("display", "none")
  $(".message-con").css("display", "none")

  $(".m-message").each(function(index,message){
    $(message).click(function(){
      $(".messages-container").empty()
      $(".message-con").show()
      $(".message-bg").show()

      console.log($(this).parents(".notif-con").siblings("#rock-id").text())

      let current_user = $(this).parents(".notif-con").siblings(".m-current-user").text()
      let message_id = JSON.parse($(this).parents(".notif-con").siblings(".message-id").text())
      let rock_id = $(this).parents(".notif-con").siblings("#rock-id").text()
      let milestone_id = $(this).parents(".notif-con").siblings("#milestone-id").text()
      let message_firstname = JSON.parse($(this).parents(".notif-con").siblings(".message-firstname").text())
      let message_lastname = JSON.parse($(this).parents(".notif-con").siblings(".message-lastname").text())
      let message_time = JSON.parse($(this).parents(".notif-con").siblings(".message-time").text())
      let message_array = JSON.parse($(this).parents(".notif-con").siblings(".milestone-messages").text())
      message_array.forEach( (message,index) => {
        $(".messages-container").append(
          `<div class="d-flex mt-3">
            <div class="circle">
              <span class="circle-inner">${message_firstname[index].charAt(0)}${message_lastname[index].charAt(0)}</span>
            </div>
            <div style="margin-left: 10px;">
              <b class="message-names">${message_firstname[index]} ${message_lastname[index]}</b>
              <div style="white-space:pre-wrap">${message.replace( /\n/g, '<br>' )}</div>
              <div class="mt-2 message-sub">${message_time[index]}</div>
              <div id="del-edit-${index}" class="message-sub">
                <a href="#message-input" id="edit-message">edit</a>
                <%= link_to delete_message_path(1,1,1),data: {turbo_method: :delete, turbo_confirm: 'Are you sure?'},id:"delete-message" do %>
                  <span class="mx-2">delete</span>
                <% end %>
              </div>
            </div>
          </div>`
        );
        // Hide edit and delete
        $(`#del-edit-${index}`).hide()
      })
    })
  })
  // disable write message div
  $("#write-message").css("pointer-events", "none")

  $(".message-bg").click(function(){
      $(this).hide()
      $(".message-con").hide()
  })
});
  
</script>
